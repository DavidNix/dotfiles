#!/usr/bin/env bash
# Install Claude Code, skills, and plugins
# Works on macOS and Linux
# Usage: agent-init
# This script is idempotent - safe to run multiple times

set -euo pipefail

# Colors (ANSI escape codes - work on both macOS and Linux)
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color

echo "Agent Initialization"
echo "===================="

# Helper: run command, warn on failure with error output
try_or_warn() {
    local desc="$1"
    shift
    local output
    if output=$("$@" 2>&1); then
        return 0
    else
        echo -e "${YELLOW}Warning: Failed: ${desc}${NC}"
        echo -e "${YELLOW}  ${output}${NC}"
        return 0  # Continue anyway
    fi
}

# Install Claude Code via official installer (if not already installed)
install_claude() {
    echo ""
    if command -v claude &>/dev/null; then
        echo -e "${GRAY}Claude Code already installed, skipping${NC}"
        return 0
    fi
    echo "Installing Claude Code..."
    curl -fsSL https://claude.ai/install.sh | bash
    echo -e "${GREEN}Claude Code installed${NC}"
}

# Install a skill via npx skills
install_skill() {
    local repo="$1"
    local skill="$2"
    echo -e "  Installing ${skill}..."
    # To add codex support in the future: -a "codex". codex does not handle skills as well as claude code and
    # I use codex more for code review vs. implementation
    try_or_warn "install $skill" npx skills add "$repo" --skill "$skill" -g -y -a "claude-code" -a "opencode"
}

# Install skills via npx
install_skills() {
    echo ""
    echo "Installing skills..."

    # Vercel skills
    install_skill "https://github.com/vercel-labs/skills" "find-skills"
    install_skill "https://github.com/vercel-labs/agent-skills" "web-design-guidelines"

    # Superpowers
    install_skill "https://github.com/obra/superpowers" "brainstorming"
    install_skill "https://github.com/obra/superpowers" "test-driven-development"

    # Anthropic skills
    install_skill "https://github.com/anthropics/skills" "pdf"
    install_skill "https://github.com/anthropics/skills" "xlsx"
    install_skill "https://github.com/anthropics/skills" "docx"
    install_skill "https://github.com/anthropics/skills" "frontend-design"

    # Snarktank
    install_skill "https://github.com/snarktank/ralph" "prd"

    echo -e "${GREEN}Skills installed${NC}"
}

# Check if marketplace is already added
has_marketplace() {
    local name="$1"
    claude plugin marketplace list 2>/dev/null | grep -q "$name"
}

# Check if plugin is already installed
has_plugin() {
    local name="$1"
    claude plugin list 2>/dev/null | grep -q "$name"
}

# Add marketplace if not already added
add_marketplace() {
    local name="$1"
    local url="$2"
    if has_marketplace "$name"; then
        echo -e "${GRAY}  $name already added${NC}"
    else
        try_or_warn "add $name" claude plugin marketplace add "$url"
        echo -e "${GREEN}  $name added${NC}"
    fi
}

# Install plugin if not already installed
install_plugin() {
    local name="$1"
    if has_plugin "$name"; then
        echo -e "${GRAY}  $name already installed${NC}"
    else
        try_or_warn "install $name" claude plugin install "$name"
        echo -e "${GREEN}  $name installed${NC}"
    fi
}

# Add marketplaces
add_marketplaces() {
    echo ""
    echo "Adding marketplaces..."
    add_marketplace "claude-plugins-official" "anthropics/claude-plugins-official"
}

# Install plugins
install_plugins() {
    echo ""
    echo "Installing plugins..."

    # Claude plugins official (LSPs, context7, playwright)
    install_plugin "context7@claude-plugins-official"
    install_plugin "playwright@claude-plugins-official"
    install_plugin "gopls-lsp@claude-plugins-official"
    install_plugin "lua-lsp@claude-plugins-official"
    install_plugin "pyright-lsp@claude-plugins-official"
    install_plugin "rust-analyzer-lsp@claude-plugins-official"
    install_plugin "swift-lsp@claude-plugins-official"
    install_plugin "typescript-lsp@claude-plugins-official"
}

main() {
    install_claude
    install_skills
    add_marketplaces
    install_plugins

    echo ""
    echo -e "${GREEN}Done!${NC} Run 'claude plugin list' to verify plugins."
}

main
