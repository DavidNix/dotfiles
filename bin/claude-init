#!/usr/bin/env bash
# Install Claude Code and setup plugins
# Works on macOS and Linux
# Usage: claude-init
# This script is idempotent - safe to run multiple times

set -euo pipefail

# Colors (ANSI escape codes - work on both macOS and Linux)
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color

echo "Claude Code Initialization"
echo "=========================="

# Helper: run command, warn on failure with error output
try_or_warn() {
    local desc="$1"
    shift
    local output
    if output=$("$@" 2>&1); then
        return 0
    else
        echo -e "${YELLOW}Warning: Failed: ${desc}${NC}"
        echo -e "${YELLOW}  ${output}${NC}"
        return 0  # Continue anyway
    fi
}

# Install Claude Code via official installer (if not already installed)
install_claude() {
    echo ""
    if command -v claude &>/dev/null; then
        echo -e "${GRAY}Claude Code already installed, skipping${NC}"
        return 0
    fi
    echo "Installing Claude Code..."
    curl -fsSL https://claude.ai/install.sh | bash
    echo -e "${GREEN}Claude Code installed${NC}"
}

# Check for SSH access to GitHub (needed for nixpowers private repo)
check_github_ssh() {
    echo ""
    echo "Checking GitHub SSH authentication..."
    if ssh -T git@github.com 2>&1 | grep -q "successfully authenticated"; then
        echo -e "${GREEN}GitHub SSH authentication successful${NC}"
        return 0
    else
        echo -e "${YELLOW}Warning: GitHub SSH authentication failed${NC}"
        echo -e "${YELLOW}  nixpowers (private repo) will be skipped.${NC}"
        echo -e "${YELLOW}  To enable: add SSH key to GitHub (https://github.com/settings/keys)${NC}"
        return 1
    fi
}

# Check if marketplace is already added
has_marketplace() {
    local name="$1"
    claude plugin marketplace list 2>/dev/null | grep -q "$name"
}

# Check if plugin is already installed
has_plugin() {
    local name="$1"
    claude plugin list 2>/dev/null | grep -q "$name"
}

# Add marketplace if not already added
add_marketplace() {
    local name="$1"
    local url="$2"
    if has_marketplace "$name"; then
        echo -e "${GRAY}  $name already added${NC}"
    else
        try_or_warn "add $name" claude plugin marketplace add "$url"
        echo -e "${GREEN}  $name added${NC}"
    fi
}

# Install plugin if not already installed
install_plugin() {
    local name="$1"
    if has_plugin "$name"; then
        echo -e "${GRAY}  $name already installed${NC}"
    else
        try_or_warn "install $name" claude plugin install "$name"
        echo -e "${GREEN}  $name installed${NC}"
    fi
}

# Add marketplaces
add_marketplaces() {
    echo ""
    echo "Adding marketplaces..."

    # Public marketplaces
    add_marketplace "superpowers-marketplace" "obra/superpowers-marketplace"
    add_marketplace "claude-plugins-official" "anthropics/claude-plugins-official"
    add_marketplace "anthropic-agent-skills" "anthropics/skills"

    # Private marketplace (nixpowers) - only if SSH auth works
    if [[ "${SKIP_PRIVATE:-}" != "1" ]]; then
        add_marketplace "nixpowers-marketplace" "git@github.com:DavidNix/nixpowers.git"
    fi
}

# Install plugins
install_plugins() {
    echo ""
    echo "Installing plugins..."

    # Superpowers marketplace
    install_plugin "elements-of-style@superpowers-marketplace"

    # Claude plugins official
    install_plugin "code-simplifier@claude-plugins-official"
    install_plugin "context7@claude-plugins-official"
    install_plugin "frontend-design@claude-plugins-official"
    install_plugin "gopls-lsp@claude-plugins-official"
    install_plugin "hookify@claude-plugins-official"
    install_plugin "lua-lsp@claude-plugins-official"
    install_plugin "playwright@claude-plugins-official"
    install_plugin "pyright-lsp@claude-plugins-official"
    install_plugin "ralph-loop@claude-plugins-official"
    install_plugin "rust-analyzer-lsp@claude-plugins-official"
    install_plugin "superpowers@claude-plugins-official"
    install_plugin "swift-lsp@claude-plugins-official"
    install_plugin "typescript-lsp@claude-plugins-official"

    # Anthropic agent skills
    install_plugin "document-skills@anthropic-agent-skills"

    # Nixpowers (private)
    if [[ "${SKIP_PRIVATE:-}" != "1" ]]; then
        install_plugin "nixpowers@nixpowers-marketplace"
    fi
}

main() {
    install_claude

    # Check SSH auth for nixpowers (non-fatal)
    if ! check_github_ssh; then
        export SKIP_PRIVATE=1
    fi

    add_marketplaces
    install_plugins

    echo ""
    echo -e "${GREEN}Done!${NC} Run 'claude plugin list' to verify."
}

main
