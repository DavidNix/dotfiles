#!/bin/bash
# ai-sandbox - Run AI coding agents in an isolated Apple Container environment
# Mimics Docker sandbox functionality using Apple's container tool

set -euo pipefail

# Configuration
SANDBOX_IMAGE="ai-sandbox:latest"
DOCKERFILE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAUDE_VOLUME="claude-config"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

ensure_volume() {
    if ! container volume list 2>/dev/null | grep -q "$CLAUDE_VOLUME"; then
        container volume create "$CLAUDE_VOLUME"
    fi
}

refresh_claude_config() {
    ensure_volume
    local host_home="$HOME"
    local host_uid host_gid
    host_uid=$(id -u)
    host_gid=$(id -g)

    log_info "Refreshing Claude credentials in volume..."

    container run --rm \
        -e "HOST_UID=${host_uid}" \
        -e "HOST_GID=${host_gid}" \
        --mount "type=bind,source=${host_home},target=/host-home,readonly" \
        --mount "type=volume,source=${CLAUDE_VOLUME},target=/claude-config" \
        "$SANDBOX_IMAGE" \
        bash -c '
            rm -rf /claude-config/*
            cp -R /host-home/.claude/. /claude-config/ 2>/dev/null || true
            cp /host-home/.claude.json /claude-config/_claude.json 2>/dev/null || true
            chown -R "${HOST_UID}:${HOST_GID}" /claude-config 2>/dev/null || true
            chmod -R 700 /claude-config 2>/dev/null || true
            echo "Credentials refreshed"
        '

    log_success "Claude credentials updated"
}

# Show usage
usage() {
    cat <<EOF
Usage: ai-sandbox [OPTIONS] [AGENT] [AGENT_ARGS...]

Run AI coding agents in an isolated container environment.

COMMANDS:
    claude      Run Claude Code
    shell       Open interactive shell
    build       Build/rebuild the sandbox image
    reset       Remove sandbox and refresh Claude credentials from host

OPTIONS:
    -h, --help  Show this help message

EXAMPLES:
    ai-sandbox claude                   # Run Claude (builds image if needed)
    ai-sandbox shell                    # Open shell in sandbox
    ai-sandbox build                    # Build/rebuild the image
    ai-sandbox reset                    # Reset sandbox and credentials

EOF
}

ensure_system_running() {
    if ! container system info &>/dev/null; then
        log_info "Starting container system..."
        container system start
        sleep 2
    fi
}

# Build the sandbox image if it doesn't exist
build_image() {
    local force="${1:-}"
    if [[ -z "$force" ]] && container image list 2>/dev/null | grep -q "$SANDBOX_IMAGE"; then
        return 0
    fi

    local host_home host_uid host_gid
    host_home="$HOME"
    host_uid=$(id -u)
    host_gid=$(id -g)

    log_info "Building sandbox image..."

    container build \
        -f "${DOCKERFILE_DIR}/Dockerfile.ai-sandbox" \
        -t "$SANDBOX_IMAGE" \
        --build-arg "HOST_HOME=${host_home}" \
        --build-arg "HOST_UID=${host_uid}" \
        --build-arg "HOST_GID=${host_gid}" \
        "${DOCKERFILE_DIR}"

    log_success "Image built successfully"
}

container_name_from_dir() {
    local dir="$1"
    echo "sandbox-$(echo "$dir" | md5 | cut -c1-12)"
}

container_exists() {
    local name="$1"
    container list -a 2>/dev/null | grep -q "$name"
}

remove_container() {
    local name="$1"
    if container_exists "$name"; then
        log_info "Removing existing container: $name"
        container stop "$name" 2>/dev/null || true
        container rm "$name" 2>/dev/null || true
    fi
}

run_sandbox() {
    local work_dir="$1"
    local container_name="$2"
    local agent="$3"
    shift 3
    local -a agent_args=("$@")

    # Use absolute path
    work_dir=$(cd "$work_dir" && pwd)
    local container_home="${HOME}"
    local host_uid host_gid
    host_uid=$(id -u)
    host_gid=$(id -g)
    local memory
    if [[ -n "${AI_SANDBOX_MEMORY+x}" ]]; then
        memory="${AI_SANDBOX_MEMORY}"
    else
        memory="4G"
    fi
    local cpus="${AI_SANDBOX_CPUS:-}"
    local prep_cmd
prep_cmd=$(cat <<'EOF'
: "${XDG_CONFIG_HOME:=$HOME/.config}"
: "${XDG_CACHE_HOME:=$HOME/.cache}"
: "${XDG_DATA_HOME:=$HOME/.local/share}"
: "${XDG_STATE_HOME:=$HOME/.local/state}"
mkdir -p "$HOME" "$XDG_CONFIG_HOME" "$XDG_CACHE_HOME" "$XDG_DATA_HOME" \
  "$XDG_STATE_HOME" "$HOME/.local/bin" "$HOME/.local/home"
if [ ! -x "$HOME/.local/bin/claude" ] && [ -x /usr/local/bin/claude ]; then
  ln -sf /usr/local/bin/claude "$HOME/.local/bin/claude"
fi
cp "$HOME/.claude/_claude.json" "$HOME/.claude.json" 2>/dev/null || true
if [ -f .tool-versions ] || [ -f .mise.toml ] || [ -f mise.toml ]; then
  /usr/local/bin/mise install --yes 2>&1 | tail -5 || true
  eval "$(/usr/local/bin/mise activate bash)" 2>/dev/null || true
fi
EOF
)

    log_info "Starting sandbox for: $work_dir"

    # Get git config for env vars (can't mount files, only directories)
    local git_name git_email
    git_name=$(git config --global user.name 2>/dev/null || echo "")
    git_email=$(git config --global user.email 2>/dev/null || echo "")

    # Build run command
    local run_args=(
        "--interactive"
        "--tty"
        "--name" "$container_name"
        "--uid" "$host_uid"
        "--gid" "$host_gid"
        "--mount" "type=bind,source=${work_dir},target=${work_dir}"
        "--mount" "type=volume,source=${CLAUDE_VOLUME},target=${container_home}/.claude"
        "-w" "$work_dir"
        # "--ssh" # leaving out for now, don't want it comitting to remotes yet
        "-e" "HOME=${container_home}"
        "-e" "PATH=${container_home}/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        "-e" "ZDOTDIR=/root" # prevents zsh warnings
        "-e" "GIT_AUTHOR_NAME=${git_name}"
        "-e" "GIT_COMMITTER_NAME=${git_name}"
        "-e" "GIT_AUTHOR_EMAIL=${git_email}"
        "-e" "GIT_COMMITTER_EMAIL=${git_email}"
    )
    if [[ -n "$memory" ]]; then
        run_args+=("--memory" "$memory")
    fi
    if [[ -n "$cpus" ]]; then
        run_args+=("--cpus" "$cpus")
    fi
    # Determine what to run
    local cmd=()
    case "$agent" in
        claude)
            cmd=("/bin/bash" "-lc" "${prep_cmd}; exec \"\$@\"" "bash" "claude" "--dangerously-skip-permissions" "--no-chrome")
            if ((${#agent_args[@]})); then
                cmd+=("${agent_args[@]}")
            fi
            ;;
        codex)
            log_warn "Codex support is planned but not yet implemented"
            exit 0
            ;;
        shell)
            cmd=("/bin/bash" "-lc" "${prep_cmd}; exec /bin/zsh")
            ;;
        *)
            cmd=("/bin/bash" "-lc" "${prep_cmd}; exec \"\$@\"" "bash" "$agent")
            if ((${#agent_args[@]})); then
                cmd+=("${agent_args[@]}")
            fi
            ;;
    esac

    if container_exists "$container_name"; then
        remove_container "$container_name"
    fi

    log_info "Creating sandbox: $container_name"
    container run "${run_args[@]}" "$SANDBOX_IMAGE" "${cmd[@]}"
}

main() {
    local work_dir="."
    local agent=""
    local agent_args=()

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            claude|codex|shell|reset|build)
                agent="$1"
                shift
                agent_args=("$@")
                break
                ;;
            -*)
                log_error "Unknown option: $1"
                usage
                exit 1
                ;;
            *)
                agent="$1"
                shift
                agent_args=("$@")
                break
                ;;
        esac
    done

    # Require a command
    if [[ -z "$agent" ]]; then
        log_error "Command required"
        usage
        exit 1
    fi

    # Validate working directory
    if [[ ! -d "$work_dir" ]]; then
        log_error "Directory does not exist: $work_dir"
        exit 1
    fi

    # Generate container name from directory
    work_dir=$(cd "$work_dir" && pwd)
    local container_name
    container_name=$(container_name_from_dir "$work_dir")

    if [[ "$agent" == "build" ]]; then
        ensure_system_running
        build_image true
        exit 0
    fi

    if [[ "$agent" == "reset" ]]; then
        ensure_system_running
        build_image
        remove_container "$container_name"
        refresh_claude_config
        log_success "Sandbox reset"
        exit 0
    fi

    ensure_system_running

    build_image

    run_sandbox "$work_dir" "$container_name" "$agent" ${agent_args[@]+"${agent_args[@]}"}
}

main "$@"
